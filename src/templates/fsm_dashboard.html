{% extends "base.html" %}

{% block title %}FSM Dashboard - Vulcan Sentinel{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">FSM Dashboard - Automatic Report Generation</h1>
        </div>
    </div>

    <!-- FSM Status Overview -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">FSM System Status</h5>
                </div>
                <div class="card-body">
                    <div id="fsm-status">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Current State</h5>
                </div>
                <div class="card-body">
                    <div id="current-state">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FSM Configuration -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">FSM Configuration</h5>
                    <button class="btn btn-sm btn-primary float-end" onclick="editConfig()">Edit Config</button>
                </div>
                <div class="card-body">
                    <div id="fsm-config">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent FSM Runs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recent FSM Runs</h5>
                    <button class="btn btn-sm btn-secondary float-end" onclick="refreshRuns()">Refresh</button>
                </div>
                <div class="card-body">
                    <div id="fsm-runs">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Modal -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit FSM Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="configForm">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Timing Parameters</h6>
                            <div class="mb-3">
                                <label for="sampling_period_s" class="form-label">Sampling Period (seconds)</label>
                                <input type="number" class="form-control" id="sampling_period_s" step="0.1" min="0.5">
                            </div>
                            <div class="mb-3">
                                <label for="T_stable_s" class="form-label">Stable Time (seconds)</label>
                                <input type="number" class="form-control" id="T_stable_s" min="10">
                            </div>
                            <div class="mb-3">
                                <label for="Max_ramp_s" class="form-label">Max Ramp Time (seconds)</label>
                                <input type="number" class="form-control" id="Max_ramp_s" min="60">
                            </div>
                            <div class="mb-3">
                                <label for="Max_stage_s" class="form-label">Max Stage Time (seconds)</label>
                                <input type="number" class="form-control" id="Max_stage_s" min="300">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Temperature Parameters</h6>
                            <div class="mb-3">
                                <label for="Tol_F" class="form-label">Tolerance (°F)</label>
                                <input type="number" class="form-control" id="Tol_F" step="0.5" min="1">
                            </div>
                            <div class="mb-3">
                                <label for="DeltaRamp_F" class="form-label">Ramp Detection (°F)</label>
                                <input type="number" class="form-control" id="DeltaRamp_F" step="0.5" min="5">
                            </div>
                            <div class="mb-3">
                                <label for="DeltaOff_F" class="form-label">Exit Threshold (°F)</label>
                                <input type="number" class="form-control" id="DeltaOff_F" step="0.5" min="5">
                            </div>
                            <div class="mb-3">
                                <label for="S_min_F" class="form-label">Min Setpoint Change (°F)</label>
                                <input type="number" class="form-control" id="S_min_F" step="0.5" min="5">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveConfig()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
let configModal;
let currentConfig = {};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    configModal = new bootstrap.Modal(document.getElementById('configModal'));
    loadFSMStatus();
    loadFSMConfig();
    loadFSMRuns();
    
    // Auto-refresh every 5 seconds
    setInterval(loadFSMStatus, 5000);
});

function loadFSMStatus() {
    fetch('/api/fsm/status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateStatusDisplay(data.data);
            }
        })
        .catch(error => {
            console.error('Error loading FSM status:', error);
        });
}

function updateStatusDisplay(data) {
    // Update FSM Worker Status
    const fsmStatusDiv = document.getElementById('fsm-status');
    if (data.fsm_worker) {
        const worker = data.fsm_worker;
        fsmStatusDiv.innerHTML = `
            <div class="row">
                <div class="col-6">
                    <strong>Status:</strong> 
                    <span class="badge ${worker.running ? 'bg-success' : 'bg-danger'}">
                        ${worker.running ? 'Running' : 'Stopped'}
                    </span>
                </div>
                <div class="col-6">
                    <strong>Line ID:</strong> ${worker.line_id}
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-6">
                    <strong>Samples Processed:</strong> ${worker.samples_processed}
                </div>
                <div class="col-6">
                    <strong>Events Generated:</strong> ${worker.events_generated}
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-6">
                    <strong>Queue Size:</strong> ${worker.queue_size}
                </div>
                <div class="col-6">
                    <strong>Last Sample:</strong> ${worker.last_sample_time ? new Date(worker.last_sample_time).toLocaleString() : 'Never'}
                </div>
            </div>
        `;
    } else {
        fsmStatusDiv.innerHTML = '<div class="text-muted">FSM Worker not available</div>';
    }
    
    // Update Current State
    const currentStateDiv = document.getElementById('current-state');
    if (data.runtime_state) {
        const state = data.runtime_state;
        currentStateDiv.innerHTML = `
            <div class="row">
                <div class="col-6">
                    <strong>Current State:</strong>
                </div>
                <div class="col-6">
                    <span class="badge bg-primary">${state.state}</span>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-6">
                    <strong>Current Stage:</strong>
                </div>
                <div class="col-6">
                    ${state.stage || 'None'}
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-6">
                    <strong>Run ID:</strong>
                </div>
                <div class="col-6">
                    ${state.run_id || 'None'}
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-6">
                    <strong>Setpoint Ref:</strong>
                </div>
                <div class="col-6">
                    ${state.sp_ref ? state.sp_ref.toFixed(1) + '°F' : 'None'}
                </div>
            </div>
        `;
    } else {
        currentStateDiv.innerHTML = '<div class="text-muted">No runtime state available</div>';
    }
}

function loadFSMConfig() {
    fetch('/api/fsm/config')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                currentConfig = data.data;
                updateConfigDisplay(data.data);
            }
        })
        .catch(error => {
            console.error('Error loading FSM config:', error);
        });
}

function updateConfigDisplay(config) {
    const configDiv = document.getElementById('fsm-config');
    configDiv.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Timing Parameters</h6>
                <ul class="list-unstyled">
                    <li><strong>Sampling Period:</strong> ${config.sampling_period_s}s</li>
                    <li><strong>Stable Time:</strong> ${config.T_stable_s}s</li>
                    <li><strong>Max Ramp Time:</strong> ${config.Max_ramp_s}s</li>
                    <li><strong>Max Stage Time:</strong> ${config.Max_stage_s}s</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Temperature Parameters</h6>
                <ul class="list-unstyled">
                    <li><strong>Tolerance:</strong> ±${config.Tol_F}°F</li>
                    <li><strong>Ramp Detection:</strong> ${config.DeltaRamp_F}°F</li>
                    <li><strong>Exit Threshold:</strong> ${config.DeltaOff_F}°F</li>
                    <li><strong>Min Setpoint Change:</strong> ${config.S_min_F}°F</li>
                </ul>
            </div>
        </div>
    `;
}

function loadFSMRuns() {
    fetch('/api/fsm/runs?limit=20')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateRunsDisplay(data.data);
            }
        })
        .catch(error => {
            console.error('Error loading FSM runs:', error);
        });
}

function updateRunsDisplay(runs) {
    const runsDiv = document.getElementById('fsm-runs');
    
    if (runs.length === 0) {
        runsDiv.innerHTML = '<div class="text-muted">No FSM runs found</div>';
        return;
    }
    
    let tableHTML = `
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Run ID</th>
                        <th>Started</th>
                        <th>Ended</th>
                        <th>End Reason</th>
                        <th>Preheat</th>
                        <th>Main Heat</th>
                        <th>Rib Heat</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    runs.forEach(run => {
        const startTime = new Date(run.started_at).toLocaleString();
        const endTime = run.ended_at ? new Date(run.ended_at).toLocaleString() : 'Running';
        const endReason = run.end_reason || 'N/A';
        
        const preheatStatus = run.preheat_ok !== null ? 
            (run.preheat_ok ? '✓' : '✗') : 'N/A';
        const mainStatus = run.main_ok !== null ? 
            (run.main_ok ? '✓' : '✗') : 'N/A';
        const ribStatus = run.rib_ok !== null ? 
            (run.rib_ok ? '✓' : '✗') : 'N/A';
        
        tableHTML += `
            <tr>
                <td><code>${run.run_id}</code></td>
                <td>${startTime}</td>
                <td>${endTime}</td>
                <td><span class="badge bg-secondary">${endReason}</span></td>
                <td>${preheatStatus}</td>
                <td>${mainStatus}</td>
                <td>${ribStatus}</td>
            </tr>
        `;
    });
    
    tableHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    runsDiv.innerHTML = tableHTML;
}

function editConfig() {
    // Populate form with current values
    Object.keys(currentConfig).forEach(key => {
        const input = document.getElementById(key);
        if (input) {
            input.value = currentConfig[key];
        }
    });
    
    configModal.show();
}

function saveConfig() {
    const formData = {};
    const form = document.getElementById('configForm');
    const inputs = form.querySelectorAll('input');
    
    inputs.forEach(input => {
        if (input.value !== '') {
            formData[input.id] = parseFloat(input.value);
        }
    });
    
    fetch('/api/fsm/config', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            configModal.hide();
            loadFSMConfig();
            showAlert('Configuration updated successfully', 'success');
        } else {
            showAlert('Failed to update configuration: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving config:', error);
        showAlert('Error saving configuration', 'danger');
    });
}

function refreshRuns() {
    loadFSMRuns();
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}
